#!/bin/bash
set -eu

# Brewfile hash: {{ include "packages/Brewfile" | sha256sum }}

{{ template "bash-lib" }}

#==============================================================================
# Install Homebrew packages
#==============================================================================

if ! command -v brew &> /dev/null; then
    info "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

info "Installing Homebrew packages..."
export HOMEBREW_CASK_OPTS="--no-quarantine --force --overwrite"
brew bundle --file={{ .chezmoi.sourceDir }}/packages/Brewfile

info "Cleaning up..."
brew autoremove
brew cleanup

#==============================================================================
# Accept Xcode license
#==============================================================================

if mas list | grep -q Xcode; then
  # Only set xcode-select if it's not already pointing to the right path
  CURRENT_XCODE_PATH=$(xcode-select -p 2>/dev/null || echo "")
  if [ "$CURRENT_XCODE_PATH" != "/Applications/Xcode.app/Contents/Developer" ]; then
    info "Setting Xcode developer directory..."
    sudo xcode-select -s /Applications/Xcode.app/Contents/Developer || warning "Failed to set Xcode path (needs sudo)"
  fi

  # Check if license needs accepting
  if command -v xcodebuild &> /dev/null; then
    XCODE_VERSION=$(xcodebuild -version 2>/dev/null | grep '^Xcode\s' | sed -E 's/^Xcode[[:space:]]+([0-9\.]+)/\1/' || echo "")
    ACCEPTED_LICENSE_VERSION=$(defaults read /Library/Preferences/com.apple.dt.Xcode 2> /dev/null | grep IDEXcodeVersionForAgreedToGMLicense | cut -d '"' -f 2 || echo "")

    if [ -n "$XCODE_VERSION" ] && [ "$XCODE_VERSION" != "$ACCEPTED_LICENSE_VERSION" ]; then
      info "Accepting Xcode license..."
      xcodebuild -runFirstLaunch 2>/dev/null || true
      sudo xcodebuild -license accept || warning "Failed to accept Xcode license (needs sudo)"
    fi
  fi
fi

#==============================================================================
# Configure fish shell
#==============================================================================

info "Configuring fish shell..."
if ! grep -q $(which fish) /etc/shells 2>/dev/null; then
     info "Adding fish to /etc/shells..."
     sudo bash -c 'echo $(which fish) >> /etc/shells' || warning "Failed to add fish to /etc/shells (needs sudo)"
     chsh -s $(which fish) 2>/dev/null || warning "Failed to change shell to fish (run 'chsh -s $(which fish)' manually)"
fi

# Install/update fish plugins via fisher
if command -v fish &> /dev/null; then
    info "Installing fish plugins..."
    fish -c "
        # Install fisher if not present
        if ! type -q fisher
            curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source
            fisher install jorgebucaran/fisher
        end
        # Update all plugins from fish_plugins
        fisher update
    " || warning "Failed to update fish plugins"
fi

#==============================================================================
# Configure docker + colima
#==============================================================================

info "Configuring docker + colima..."

# Compose is now a Docker plugin. For Docker to find this plugin, symlink it
mkdir -p ~/.docker/cli-plugins
ln -sfn /opt/homebrew/opt/docker-compose/bin/docker-compose ~/.docker/cli-plugins/docker-compose
ln -sfn /opt/homebrew/bin/docker-buildx ~/.docker/cli-plugins/docker-buildx

#==============================================================================
# Misc
#==============================================================================

info "Adding bat themes..."
bat cache --build

success "Homebrew installation complete!"
