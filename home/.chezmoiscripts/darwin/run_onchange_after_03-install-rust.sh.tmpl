#!/bin/bash
set -eu

# Rust tools hash: {{ include "packages/rust-tools.txt" | sha256sum }}

{{ template "bash-lib" }}

#==============================================================================
# Install Rust via rustup
#==============================================================================

if ! command -v rustup &> /dev/null; then
    info "Installing rustup..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path

    # Source cargo env for current session
    source {{ .chezmoi.homeDir }}/.cargo/env
fi

info "Updating Rust toolchain..."
rustup update stable
rustup default stable

info "Installing Rust components..."
rustup component add clippy rustfmt rust-analyzer

#==============================================================================
# Install cargo packages
#==============================================================================

info "Installing cargo packages..."
while IFS= read -r package || [[ -n "$package" ]]; do
    [[ -z "$package" || "$package" =~ ^# ]] && continue

    # Check if package is already installed to avoid long rebuilds
    if ! cargo install --list | grep -q "^${package} "; then
        cargo install "$package"
    else
        info "  âœ“ $package already installed, skipping..."
    fi
done < {{ .chezmoi.sourceDir }}/packages/rust-tools.txt

#==============================================================================
# Update installed cargo packages
#==============================================================================

if command -v cargo-install-update &> /dev/null; then
    info "Updating cargo packages..."
    cargo install-update -a
fi

success "Rust toolchain installation complete!"
